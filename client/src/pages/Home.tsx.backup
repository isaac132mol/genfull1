import { useState, useMemo, useEffect } from 'react';
import { useAuth } from '@/_core/hooks/useAuth';
import { trpc } from '@/lib/trpc';
import { getLoginUrl } from '@/const';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { toast } from 'sonner';
import { 
  Copy, 
  Trash2, 
  Star, 
  CreditCard, 
  History as HistoryIcon,
  Moon,
  CloudRain,
  ArrowUpDown,
  Heart
} from 'lucide-react';
import ParticlesBackground from '@/components/ParticlesBackground';
import RainBackground from '@/components/RainBackground';

import { useTheme } from '@/contexts/ThemeContext';
import type { HistoryEntry, Stats, SortOption } from '@/types';
import {
  generateCardNumber,
  generateExpirationDate,
  generateCVV,
  formatCard,
  isValidBIN,
  extractSimilarityPattern,
  generateExtrapolations,
  getCardBrand,
} from '@/lib/cardUtils';

export default function Home() {
  // The userAuth hooks provides authentication state
  // To implement login/logout functionality, simply call logout() or redirect to getLoginUrl()
  let { user, loading, error, isAuthenticated, logout } = useAuth();

  const { theme, setTheme } = useTheme();
  const [bin, setBin] = useState('');
  const [month, setMonth] = useState('');
  const [year, setYear] = useState('');
  const [cvv, setCvv] = useState('');
  const [quantity, setQuantity] = useState(10);
  const [results, setResults] = useState('');
  
  // Extrapolator states
  const [card1, setCard1] = useState('');
  const [card2, setCard2] = useState('');
  const [similarityResult, setSimilarityResult] = useState('');
  const [extrapolationCard, setExtrapolationCard] = useState('');
  const [extrapolationResults, setExtrapolationResults] = useState('');
  
  // History and favorites - using tRPC
  const { data: historyData = [], refetch: refetchHistory } = trpc.cardHistory.list.useQuery(undefined, {
    enabled: !!user,
  });
  const createHistoryMutation = trpc.cardHistory.create.useMutation({
    onSuccess: () => refetchHistory(),
  });
  const toggleFavoriteMutation = trpc.cardHistory.toggleFavorite.useMutation({
    onSuccess: () => refetchHistory(),
  });
  const deleteHistoryMutation = trpc.cardHistory.delete.useMutation({
    onSuccess: () => refetchHistory(),
  });
  const clearHistoryMutation = trpc.cardHistory.clear.useMutation({
    onSuccess: () => refetchHistory(),
  });
  
  const [sortOption, setSortOption] = useState<SortOption>('date-desc');
  const [activeTab, setActiveTab] = useState('generator');
  
  // Convert database format to local format
  const history: HistoryEntry[] = historyData.map(entry => ({
    id: entry.id.toString(),
    bin: entry.bin,
    month: entry.month,
    year: entry.year,
    cvv: entry.cvv,
    quantity: entry.quantity,
    timestamp: entry.createdAt.getTime(),
    isFavorite: entry.isFavorite === 1,
  }));
  
  // Sort history
  const sortedHistory = useMemo(() => {
    const sorted = [...history];
    switch (sortOption) {
      case 'date-desc':
        return sorted.sort((a, b) => b.timestamp - a.timestamp);
      case 'date-asc':
        return sorted.sort((a, b) => a.timestamp - b.timestamp);
      case 'bin-asc':
        return sorted.sort((a, b) => a.bin.localeCompare(b.bin));
      case 'bin-desc':
        return sorted.sort((a, b) => b.bin.localeCompare(a.bin));
      case 'quantity-desc':
        return sorted.sort((a, b) => b.quantity - a.quantity);
      default:
        return sorted;
    }
  }, [history, sortOption]);
  
  const favoriteHistory = useMemo(() => {
    return sortedHistory.filter(entry => entry.isFavorite);
  }, [sortedHistory]);

  const handleGenerate = () => {
    if (!isValidBIN(bin)) {
      toast.error('Por favor ingresa un BIN válido (6-16 dígitos, puede incluir "x")');
      return;
    }

    const cards: string[] = [];
    for (let i = 0; i < quantity; i++) {
      const cardNumber = generateCardNumber(bin);
      const { month: expMonth, year: expYear } = generateExpirationDate(month, year);
      const cardCvv = generateCVV(cvv);
      cards.push(formatCard(cardNumber, expMonth, expYear, cardCvv));
    }

    setResults(cards.join('\n'));
    
    // Add to history via API
    if (user) {
      createHistoryMutation.mutate({
        bin,
        month: month || 'Random',
        year: year || 'Random',
        cvv: cvv || 'Random',
        quantity,
      });
    }
    
    toast.success(`${quantity} tarjetas generadas exitosamente`);
  };

  const handleSimilarity = () => {
    if (!card1 || !card2) {
      toast.error('Por favor ingresa ambas tarjetas');
      return;
    }

    const pattern = extractSimilarityPattern(card1, card2);
    if (!pattern) {
      toast.error('Las tarjetas deben tener la misma longitud');
      return;
    }

    setSimilarityResult(pattern);
    toast.success('Patrón de similitud calculado');
  };

  const handleExtrapolation = () => {
    if (!extrapolationCard) {
      toast.error('Por favor ingresa una tarjeta completa');
      return;
    }

    const patterns = generateExtrapolations(extrapolationCard);
    setExtrapolationResults(patterns.join('\n'));
    toast.success(`${patterns.length} patrones generados`);
  };

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text);
    toast.success('Copiado al portapapeles');
  };

  const toggleFavorite = (id: string) => {
    toggleFavoriteMutation.mutate({ id: parseInt(id) });
  };

  const deleteHistoryEntry = (id: string) => {
    deleteHistoryMutation.mutate({ id: parseInt(id) });
    toast.success('Entrada eliminada');
  };

  const clearHistory = () => {
    clearHistoryMutation.mutate();
    toast.success('Historial limpiado');
  };

  const loadFromHistory = (entry: HistoryEntry) => {
    setBin(entry.bin);
    setMonth(entry.month !== 'Random' ? entry.month : '');
    setYear(entry.year !== 'Random' ? entry.year : '');
    setCvv(entry.cvv !== 'Random' ? entry.cvv : '');
    setQuantity(entry.quantity);
    toast.success('Datos cargados desde historial');
  };

  return (
    <div className="min-h-screen relative overflow-hidden">
      {theme === 'rain' ? <RainBackground /> : <ParticlesBackground />}
      
      {/* Background gradient - Colores Vibrantes */}
      <div 
        className={`fixed inset-0 -z-10 transition-colors duration-700 ${
          theme === 'rain'
            ? 'bg-gradient-to-br from-cyan-950 via-blue-950 to-indigo-950'
            : 'bg-gradient-to-br from-purple-950 via-fuchsia-950 to-indigo-950'
        }`} 
      />
      
      <div className="container py-2 sm:py-8 relative z-10">
        {/* Header */}
        <div className="flex flex-col sm:flex-row justify-between items-center gap-2 sm:gap-4 mb-3 sm:mb-8">
          <div>
            <h1 className="text-2xl sm:text-4xl font-bold animate-float text-white">
              Generador de Tarjetas
            </h1>
          </div>
          
          {/* Theme Switcher */}
          <div className="flex gap-2">
            <Button
              variant={theme === 'dark' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setTheme('dark')}
              className="glass-button"
              title="Tema Espacio"
            >
              <Moon className="h-4 w-4 mr-1" />
              <span className="hidden sm:inline">Espacio</span>
            </Button>
            <Button
              variant={theme === 'rain' ? 'default' : 'outline'}
              size="sm"
              onClick={() => setTheme('rain')}
              className="glass-button"
              title="Tema Lluvia"
            >
              <CloudRain className="h-4 w-4 mr-1" />
              <span className="hidden sm:inline">Lluvia</span>
            </Button>
          </div>
        </div>

        {/* Main Content */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-3 lg:gap-6">
          {/* Left Panel - Methods and History */}
          <div className="space-y-3 lg:space-y-6">
            <Tabs defaultValue="generator" className="w-full" onValueChange={setActiveTab}>
              <TabsList className="glass-card border-white/20 w-full grid grid-cols-3 text-[10px] sm:text-sm h-8 sm:h-10">
                <TabsTrigger value="generator" className="data-[state=active]:glass-button flex items-center justify-center gap-1 sm:gap-2">
                  <CreditCard className="h-3 w-3 sm:h-4 sm:w-4" />
                  Generador
                </TabsTrigger>
                <TabsTrigger value="similarity" className="data-[state=active]:glass-button flex items-center justify-center gap-1 sm:gap-2">
                  <Star className="h-3 w-3 sm:h-4 sm:w-4" />
                  Similitud
                </TabsTrigger>
                <TabsTrigger value="extrapolation" className="data-[state=active]:glass-button flex items-center justify-center gap-1 sm:gap-2">
                  <ArrowUpDown className="h-3 w-3 sm:h-4 sm:w-4" />
                  Extrapolación
                </TabsTrigger>
              </TabsList>

              {/* Generator Tab */}
              <TabsContent value="generator" className="space-y-0">
                <Card className="glass-card border-white/20">
                  <CardContent className="space-y-2 sm:space-y-4 pt-3 sm:pt-6 p-3 sm:p-6">
                    <div>
                      <Label htmlFor="bin" className="text-white">BIN</Label>
                      <Input
                        id="bin"
                        value={bin}
                        onChange={(e) => setBin(e.target.value)}
                        placeholder="456331004806xxxx"
                        maxLength={16}
                        className="glass-input text-white placeholder:text-white/50"
                      />
                      {bin && <p className="text-sm text-white/70 mt-1">Marca: {getCardBrand(bin)}</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="month" className="text-white">Mes</Label>
                        <Input
                          id="month"
                          value={month}
                          onChange={(e) => setMonth(e.target.value)}
                          placeholder="MM"
                          maxLength={2}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="year" className="text-white">Año</Label>
                        <Input
                          id="year"
                          value={year}
                          onChange={(e) => setYear(e.target.value)}
                          placeholder="YYYY"
                          maxLength={4}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="cvv" className="text-white">CVV (Opcional)</Label>
                        <Input
                          id="cvv"
                          value={cvv}
                          onChange={(e) => setCvv(e.target.value)}
                          placeholder="123"
                          maxLength={3}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="quantity" className="text-white">Cantidad</Label>
                        <Input
                          id="quantity"
                          type="number"
                          value={quantity}
                          onChange={(e) => setQuantity(Number(e.target.value))}
                          min={1}
                          max={100}
                          className="glass-input text-white"
                        />
                      </div>
                    </div>

                    <Button onClick={handleGenerate} className="w-full glass-button h-9 sm:h-10 text-sm">
                      Generar Tarjetas
                    </Button>

                    <div>
                      <div className="flex justify-between items-center mb-1 sm:mb-2">
                        <Label className="text-white text-xs sm:text-sm">Resultados</Label>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => copyToClipboard(results)}
                          disabled={!results}
                          className="glass-button"
                        >
                          <Copy className="h-4 w-4" />
                        </Button>
                      </div>
                      <Textarea
                        value={results}
                        readOnly
                        rows={12}
                        className="glass-input text-white font-mono text-xs sm:text-sm"
                        placeholder="Tus resultados aparecerán aquí..."
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>

              {/* Similarity Tab */}
              <TabsContent value="similarity" className="space-y-3 lg:space-y-6">
                <Card className="glass-card border-white/20">
                  <CardContent className="space-y-2 sm:space-y-4 pt-3 sm:pt-6 p-3 sm:p-6">
                    <div>
                      <Label htmlFor="card1" className="text-white">Tarjeta 1</Label>
                      <Input
                        id="card1"
                        value={card1}
                        onChange={(e) => setCard1(e.target.value)}
                        placeholder="4915110191768499"
                        className="glass-input text-white placeholder:text-white/50"
                      />
                    </div>

                    <div>
                      <Label htmlFor="card2" className="text-white">Tarjeta 2</Label>
                      <Input
                        id="card2"
                        value={card2}
                        onChange={(e) => setCard2(e.target.value)}
                        placeholder="4915110176928790"
                        className="glass-input text-white placeholder:text-white/50"
                      />
                    </div>

                    <Button onClick={handleSimilarity} className="w-full glass-button">
                      Calcular Similitud
                    </Button>

                    <div>
                      <div className="flex justify-between items-center mb-1 sm:mb-2">
                        <Label className="text-white">Resultado</Label>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => copyToClipboard(similarityResult)}
                          disabled={!similarityResult}
                          className="glass-button"
                        >
                          <Copy className="h-4 w-4" />
                        </Button>
                      </div>
                      <Input
                        value={similarityResult}
                        readOnly
                        className="glass-input text-white font-mono"
                        placeholder="El patrón aparecerá aquí..."
                      />
                    </div>
                  </CardContent>
                </Card>

                {/* Removed duplicate generator - now in right panel */}
              </TabsContent>

              {/* Extrapolation Tab */}
              <TabsContent value="extrapolation" className="space-y-3 lg:space-y-6">
                <Card className="glass-card border-white/20">
                  <CardContent className="space-y-2 sm:space-y-4 pt-3 sm:pt-6 p-3 sm:p-6">
                    <div>
                      <Label htmlFor="extrapolation-card" className="text-white">Tarjeta Completa</Label>
                      <Input
                        id="bin-sim"
                        value={bin}
                        onChange={(e) => setBin(e.target.value)}
                        placeholder="456331004806xxxx"
                        maxLength={16}
                        className="glass-input text-white placeholder:text-white/50"
                      />
                      {bin && <p className="text-sm text-white/70 mt-1">Marca: {getCardBrand(bin)}</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="month-sim" className="text-white">Mes</Label>
                        <Input
                          id="month-sim"
                          value={month}
                          onChange={(e) => setMonth(e.target.value)}
                          placeholder="MM"
                          maxLength={2}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="year-sim" className="text-white">Año</Label>
                        <Input
                          id="year-sim"
                          value={year}
                          onChange={(e) => setYear(e.target.value)}
                          placeholder="YYYY"
                          maxLength={4}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="cvv-sim" className="text-white">CVV (Opcional)</Label>
                        <Input
                          id="cvv-sim"
                          value={cvv}
                          onChange={(e) => setCvv(e.target.value)}
                          placeholder="123"
                          maxLength={3}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="quantity-sim" className="text-white">Cantidad</Label>
                        <Input
                          id="quantity-sim"
                          type="number"
                          value={quantity}
                          onChange={(e) => setQuantity(Number(e.target.value))}
                          min={1}
                          max={100}
                          className="glass-input text-white"
                        />
                      </div>
                    </div>

                    <Button onClick={handleGenerate} className="w-full glass-button h-9 sm:h-10 text-sm">
                      Generar Tarjetas
                    </Button>

                    <div>
                      <div className="flex justify-between items-center mb-1 sm:mb-2">
                        <Label className="text-white text-xs sm:text-sm">Resultados</Label>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => copyToClipboard(results)}
                          disabled={!results}
                          className="glass-button"
                        >
                          <Copy className="h-4 w-4" />
                        </Button>
                      </div>
                      <Textarea
                        value={results}
                        readOnly
                        rows={12}
                        className="glass-input text-white font-mono text-xs sm:text-sm"
                        placeholder="Tus resultados aparecerán aquí..."
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>

              {/* Extrapolation Tab */}
              <TabsContent value="extrapolation" className="space-y-3 lg:space-y-6">
                <Card className="glass-card border-white/20">
                  <CardContent className="space-y-2 sm:space-y-4 pt-3 sm:pt-6 p-3 sm:p-6">
                    <div>
                      <Label htmlFor="extrapolation-card" className="text-white">Tarjeta Completa</Label>
                      <Input
                        id="extrapolation-card"
                        value={extrapolationCard}
                        onChange={(e) => setExtrapolationCard(e.target.value)}
                        placeholder="4833160095772767|04|20|858"
                        className="glass-input text-white placeholder:text-white/50"
                      />
                    </div>

                    <Button onClick={handleExtrapolation} className="w-full glass-button h-9 sm:h-10 text-sm">
                      Generar Patrones
                    </Button>

                    <div>
                      <div className="flex justify-between items-center mb-1 sm:mb-2">
                        <Label className="text-white text-xs sm:text-sm">Resultados</Label>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => copyToClipboard(extrapolationResults)}
                          disabled={!extrapolationResults}
                          className="glass-button"
                        >
                          <Copy className="h-4 w-4" />
                        </Button>
                      </div>
                      <Textarea
                        value={extrapolationResults}
                        readOnly
                        rows={10}
                        className="glass-input text-white font-mono text-xs sm:text-sm"
                        placeholder="Los patrones aparecerán aquí..."
                      />
                    </div>
                  </CardContent>
                </Card>

                {/* Generator in Extrapolation Tab */}
                <Card className="glass-card border-white/20">
                  <CardContent className="space-y-2 sm:space-y-4 pt-3 sm:pt-6 p-3 sm:p-6">
                    <div>
                      <Label htmlFor="bin-ext" className="text-white">BIN</Label>
                      <Input
                        id="bin-ext"
                        value={bin}
                        onChange={(e) => setBin(e.target.value)}
                        placeholder="456331004806xxxx"
                        maxLength={16}
                        className="glass-input text-white placeholder:text-white/50"
                      />
                      {bin && <p className="text-sm text-white/70 mt-1">Marca: {getCardBrand(bin)}</p>}
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="month-ext" className="text-white">Mes</Label>
                        <Input
                          id="month-ext"
                          value={month}
                          onChange={(e) => setMonth(e.target.value)}
                          placeholder="MM"
                          maxLength={2}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="year-ext" className="text-white">Año</Label>
                        <Input
                          id="year-ext"
                          value={year}
                          onChange={(e) => setYear(e.target.value)}
                          placeholder="YYYY"
                          maxLength={4}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-3 sm:gap-4">
                      <div>
                        <Label htmlFor="cvv-ext" className="text-white">CVV (Opcional)</Label>
                        <Input
                          id="cvv-ext"
                          value={cvv}
                          onChange={(e) => setCvv(e.target.value)}
                          placeholder="123"
                          maxLength={3}
                          className="glass-input text-white placeholder:text-white/50"
                        />
                      </div>
                      <div>
                        <Label htmlFor="quantity-ext" className="text-white">Cantidad</Label>
                        <Input
                          id="quantity-ext"
                          type="number"
                          value={quantity}
                          onChange={(e) => setQuantity(Number(e.target.value))}
                          min={1}
                          max={100}
                          className="glass-input text-white"
                        />
                      </div>
                    </div>

                    <Button onClick={handleGenerate} className="w-full glass-button h-9 sm:h-10 text-sm">
                      Generar Tarjetas
                    </Button>

                    <div>
                      <div className="flex justify-between items-center mb-1 sm:mb-2">
                        <Label className="text-white text-xs sm:text-sm">Resultados</Label>
                        <Button
                          size="sm"
                          variant="ghost"
                          onClick={() => copyToClipboard(results)}
                          disabled={!results}
                          className="glass-button"
                        >
                          <Copy className="h-4 w-4" />
                        </Button>
                      </div>
                      <Textarea
                        value={results}
                        readOnly
                        rows={12}
                        className="glass-input text-white font-mono text-xs sm:text-sm"
                        placeholder="Tus resultados aparecerán aquí..."
                      />
                    </div>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>
          </div>

          {/* Right Panel - History (always visible) */}
          <div>
            <div>
              <Card className="glass-card border-white/20 lg:sticky lg:top-4 mb-4 lg:mb-0">
                <CardHeader className="pb-2 sm:pb-6 p-3 sm:p-6">
                <div className="flex justify-between items-center mb-1 sm:mb-2">
                  <CardTitle className="text-sm sm:text-lg text-white flex items-center gap-1 sm:gap-2">
                    <HistoryIcon className="h-4 w-4 sm:h-5 sm:w-5" />
                    Historial
                  </CardTitle>
                  <Button
                    size="sm"
                    variant="ghost"
                    onClick={clearHistory}
                    className="glass-button"
                  >
                    <Trash2 className="h-3 w-3 sm:h-4 sm:w-4" />
                  </Button>
                </div>
                <div className="mt-3">
                  <Select value={sortOption} onValueChange={(value) => setSortOption(value as SortOption)}>
                    <SelectTrigger className="glass-input text-white text-xs sm:text-sm">
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="date-desc">Fecha (más reciente)</SelectItem>
                      <SelectItem value="date-asc">Fecha (más antigua)</SelectItem>
                      <SelectItem value="bin-asc">BIN (A-Z)</SelectItem>
                      <SelectItem value="bin-desc">BIN (Z-A)</SelectItem>
                      <SelectItem value="quantity-desc">Cantidad (mayor)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </CardHeader>
              <CardContent>
                {/* Favorites Section */}
                {favoriteHistory.length > 0 && (
                  <div className="mb-4">
                    <h3 className="text-sm sm:text-base text-white font-semibold mb-2 flex items-center gap-2">
                      <Heart className="h-3 w-3 sm:h-4 sm:w-4 fill-red-500 text-red-500" />
                      Favoritos
                    </h3>
                    <div className="space-y-2 max-h-32 sm:max-h-40 overflow-y-auto">
                      {favoriteHistory.map((entry) => (
                        <div
                          key={entry.id}
                          className="glass-input p-2 sm:p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-all"
                          onClick={() => loadFromHistory(entry)}
                        >
                          <div className="flex justify-between items-start mb-1">
                            <p className="text-white font-mono text-sm">{entry.bin}</p>
                            <div className="flex gap-1">
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  toggleFavorite(entry.id);
                                }}
                                className="h-6 w-6 p-0"
                              >
                                <Star className="h-3 w-3 fill-yellow-500 text-yellow-500" />
                              </Button>
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={(e) => {
                                  e.stopPropagation();
                                  deleteHistoryEntry(entry.id);
                                }}
                                className="h-6 w-6 p-0"
                              >
                                <Trash2 className="h-3 w-3 text-red-500" />
                              </Button>
                            </div>
                          </div>
                          <p className="text-white/60 text-xs">
                            {entry.quantity} tarjetas • {new Date(entry.timestamp).toLocaleDateString()}
                          </p>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {/* All History */}
                <h3 className="text-sm sm:text-base text-white font-semibold mb-2">Todas las búsquedas</h3>
                <div className="space-y-2 max-h-60 sm:max-h-96 overflow-y-auto">
                  {sortedHistory.length === 0 ? (
                    <p className="text-white/50 text-sm text-center py-4">
                      No hay búsquedas recientes
                    </p>
                  ) : (
                    sortedHistory.map((entry) => (
                      <div
                        key={entry.id}
                        className="glass-input p-2 sm:p-3 rounded-lg cursor-pointer hover:bg-white/10 transition-all"
                        onClick={() => loadFromHistory(entry)}
                      >
                        <div className="flex justify-between items-start mb-1">
                          <p className="text-white font-mono text-sm">{entry.bin}</p>
                          <div className="flex gap-1">
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={(e) => {
                                e.stopPropagation();
                                toggleFavorite(entry.id);
                              }}
                              className="h-6 w-6 p-0"
                            >
                              <Star
                                className={`h-3 w-3 ${
                                  entry.isFavorite
                                    ? 'fill-yellow-500 text-yellow-500'
                                    : 'text-white/50'
                                }`}
                              />
                            </Button>
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={(e) => {
                                e.stopPropagation();
                                deleteHistoryEntry(entry.id);
                              }}
                              className="h-6 w-6 p-0"
                            >
                              <Trash2 className="h-3 w-3 text-red-500" />
                            </Button>
                          </div>
                        </div>
                        <p className="text-white/60 text-xs">
                          {entry.quantity} tarjetas • {new Date(entry.timestamp).toLocaleDateString()}
                        </p>
                      </div>
                    ))
                  )}
                </div>
              </CardContent>
            </Card>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
